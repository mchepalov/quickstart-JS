<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Быстрый старт JS</title>
  </head>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    body h1 {
      margin: 15px 0;
    }

    .section {
      margin: 40px 0;
      padding: 20px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      width: 100%;
      max-width: 800px;
    }

    .section h2 {
      color: #1f2937;
      margin-bottom: 20px;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 20px 0;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    @keyframes spinner {
      0% {
        transform: scale(0.1) rotate(0deg);
        fill: currentColor;
      }

      33% {
        transform: scale(1) rotate(150deg);
        fill: transparent;
      }

      66% {
        transform: scale(1) rotate(210deg);
        fill: transparent;
      }

      100% {
        transform: scale(0.1) rotate(360deg);
        fill: currentColor;
      }
    }

    .spinner {
      animation: spinner 1.5s infinite linear;
      color: rgb(6, 75, 67);
    }

    .hidden {
      display: none;
    }

    #result {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 20px;
      margin-top: 20px;
      min-height: 50px;
    }

    .status {
      font-weight: bold;
      margin: 10px 0;
    }
  </style>
  <body>
    <h1>Веб-компоненты</h1>

    <my-panel>
      <div slot="content">
        <my-select>
          <option value="opt1">Option 1</option>
          <option value="opt2">Option 2</option>
          <option value="opt3">Option 3</option>
        </my-select>
      </div>
    </my-panel>

    <my-card header="Карточка" sub-header="Подзаголовок">
      <div slot="content">
        <p>Содерживое карточки</p>
        <p>Информация</p>
      </div>
      <div slot="footer">
        <p>Содержимое футера карточки</p>
      </div>
    </my-card>

    <div class="section">
      <h2>Service Worker API - Демонстрация</h2>
      <div class="container">
        <button id="start">Запустить вычисления!</button>
        <button id="unregister">Unregister Service Worker</button>

        <div id="spinner" class="hidden">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="64"
            height="56"
            fill="none"
            class="spinner"
          >
            <path
              stroke="currentColor"
              stroke-width="4"
              d="M3.464 30a4 4 0 0 1 0-4L16 4.287a4 4 0 0 1 3.464-2h25.072a4 4 0 0 1 3.464 2L60.536 26a4 4 0 0 1 0 4L48 51.713a4 4 0 0 1-3.464 2H19.464a4 4 0 0 1-3.464-2L3.464 30Z"
            />
          </svg>
        </div>

        <div class="status" id="status">Готов к работе</div>

        <div id="result">Результат появится здесь...</div>
      </div>
    </div>

    <script>
      // Загрузка веб-компонентов
      const onError = (err) => {
        console.error('Ошибка загрузки:', err);
      };

      const components = ['my-select', 'my-panel', 'my-card'];

      components.forEach((component) => {
        const script = document.createElement('script');
        script.src = `./${component}.js`;
        script.addEventListener('error', onError);
        document.body.append(script);
      });

      // Service Worker API
      const getServiceWorker = async (scriptURL, options) => {
        if ('serviceWorker' in navigator) {
          try {
            let registration = await navigator.serviceWorker.getRegistration();
            if (!registration) {
              registration = await navigator.serviceWorker.register(
                scriptURL,
                options
              );
              await navigator.serviceWorker.ready;
            }
            return {
              registration: registration,
              container: navigator.serviceWorker,
              controller: registration.active,
              addEventListener: navigator.serviceWorker.addEventListener.bind(
                navigator.serviceWorker
              ),
              postMessage: registration.active.postMessage.bind(
                registration.active
              ),
            };
          } catch (error) {
            console.error(`Registration failed with ${error}`);
          }
        }
      };

      let serviceWorker = null;

      // Инициализация Service Worker
      (async () => {
        serviceWorker = await getServiceWorker('./service-worker.js', {
          scope: './',
        });
        if (!serviceWorker) {
          document.getElementById('status').textContent =
            'Service Worker не поддерживается';
          return;
        }
        console.log('Service Worker зарегистрирован:', serviceWorker);

        // Запрашиваем закешированный результат при загрузке
        serviceWorker.postMessage({ type: 'getCached', timeout: 3000 });
      })();

      // Обработчик сообщений от Service Worker
      navigator.serviceWorker.addEventListener('message', (event) => {
        const data = event.data;
        const result = document.getElementById('result');

        if (data.type === 'cachedResult') {
          result.innerHTML = `
            <h3>Закешированный результат:</h3>
            <p><strong>Значение:</strong> ${data.result.result}</p>
            <p><strong>Время выполнения:</strong> ${data.result.duration}мс</p>
            <p><strong>Итераций:</strong> ${data.result.iterations}</p>
            <p><em>Данные получены из кеша Service Worker</em></p>
          `;
        } else if (data.type === 'newResult') {
          result.innerHTML = `
            <h3>Новый результат:</h3>
            <p><strong>Значение:</strong> ${data.result.result}</p>
            <p><strong>Время выполнения:</strong> ${data.result.duration}мс</p>
            <p><strong>Итераций:</strong> ${data.result.iterations}</p>
            <p><em>Результат пересчитан и отправлен во все вкладки</em></p>
          `;
        }
      });

      // Обработчик кнопки Start
      document.getElementById('start').addEventListener('click', () => {
        if (!serviceWorker) {
          alert('Service Worker не зарегистрирован!');
          return;
        }

        const button = document.getElementById('start');
        const spinner = document.getElementById('spinner');
        const status = document.getElementById('status');
        const result = document.getElementById('result');

        button.disabled = true;
        button.textContent = 'Пересчитываем...';
        spinner.classList.remove('hidden');
        status.textContent = 'Выполняем пересчет в Service Worker...';
        result.textContent = 'Ожидаем результат...';

        // Запускаем принудительную перегенерацию
        serviceWorker.postMessage({ type: 'recalculate', timeout: 3000 });

        // Разблокируем кнопку через некоторое время
        setTimeout(() => {
          button.disabled = false;
          button.textContent = 'Запустить вычисления!';
          spinner.classList.add('hidden');
          status.textContent = 'Готов к работе';
        }, 100);
      });

      // Обработчик кнопки Unregister
      document
        .getElementById('unregister')
        .addEventListener('click', async () => {
          if (serviceWorker && serviceWorker.registration) {
            await serviceWorker.registration.unregister();
            serviceWorker = null;
            document.getElementById('result').innerHTML =
              '<p>Service Worker отключен</p>';
            document.getElementById('status').textContent =
              'Service Worker отключен';
          }
        });
    </script>
  </body>
</html>
