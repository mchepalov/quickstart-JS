<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Быстрый старт JS</title>
  </head>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    body h1 {
      margin: 15px 0;
    }

    .section {
      margin: 40px 0;
      padding: 20px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      width: 100%;
      max-width: 800px;
    }

    .section h2 {
      color: #1f2937;
      margin-bottom: 20px;
    }

    button {
      background: #007bff;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      margin: 20px 0;
    }

    button:hover {
      background: #0056b3;
    }

    button:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    @keyframes spinner {
      0% {
        transform: scale(0.1) rotate(0deg);
        fill: currentColor;
      }

      33% {
        transform: scale(1) rotate(150deg);
        fill: transparent;
      }

      66% {
        transform: scale(1) rotate(210deg);
        fill: transparent;
      }

      100% {
        transform: scale(0.1) rotate(360deg);
        fill: currentColor;
      }
    }

    .spinner {
      animation: spinner 1.5s infinite linear;
      color: rgb(6, 75, 67);
    }

    .hidden {
      display: none;
    }

    #result {
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 6px;
      padding: 20px;
      margin-top: 20px;
      min-height: 50px;
    }

    .status {
      font-weight: bold;
      margin: 10px 0;
    }
  </style>
  <body>
    <h1>Веб-компоненты</h1>

    <my-panel>
      <div slot="content">
        <my-select>
          <option value="opt1">Option 1</option>
          <option value="opt2">Option 2</option>
          <option value="opt3">Option 3</option>
        </my-select>
      </div>
    </my-panel>

    <my-card header="Карточка" sub-header="Подзаголовок">
      <div slot="content">
        <p>Содерживое карточки</p>
        <p>Информация</p>
      </div>
      <div slot="footer">
        <p>Содержимое футера карточки</p>
      </div>
    </my-card>

    <div class="section">
      <h2>Web Workers API - Демонстрация</h2>
      <div class="container">
        <button id="start">Запустить вычисления!</button>

        <div id="spinner" class="hidden">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="64"
            height="56"
            fill="none"
            class="spinner"
          >
            <path
              stroke="currentColor"
              stroke-width="4"
              d="M3.464 30a4 4 0 0 1 0-4L16 4.287a4 4 0 0 1 3.464-2h25.072a4 4 0 0 1 3.464 2L60.536 26a4 4 0 0 1 0 4L48 51.713a4 4 0 0 1-3.464 2H19.464a4 4 0 0 1-3.464-2L3.464 30Z"
            />
          </svg>
        </div>

        <div class="status" id="status">Готов к работе</div>

        <div id="result">Результат появится здесь...</div>
      </div>
    </div>

    <script>
      // Загрузка веб-компонентов
      const onError = (err) => {
        console.error('Ошибка загрузки:', err);
      };

      const components = ['my-select', 'my-panel', 'my-card'];

      components.forEach((component) => {
        const script = document.createElement('script');
        script.src = `./${component}.js`;
        script.addEventListener('error', onError);
        document.body.append(script);
      });

      // Web Workers API
      let thread = null;
      let isThreadCreated = false; // Флаг для отслеживания создания воркера

      // Функция для тяжелых вычислений (для сравнения)
      const slowFunction = (timeout = 3000) => {
        let start = performance.now();
        let x = 0;
        let i = 0;
        do {
          i += 1;
          x += (Math.random() - 0.5) * i;
        } while (performance.now() - start < timeout);
        return x;
      };

      // Обработчик кнопки
      document.getElementById('start').addEventListener('click', () => {
        const button = document.getElementById('start');
        const spinner = document.getElementById('spinner');
        const status = document.getElementById('status');
        const result = document.getElementById('result');

        // Проверяем поддержку Web Workers
        if (!window.Worker) {
          alert('Ваш браузер не поддерживает Web Workers!');
          return;
        }

        // Блокируем кнопку и показываем анимацию
        button.disabled = true;
        button.textContent = isThreadCreated
          ? 'Переиспользуем воркер...'
          : 'Создаем воркер...';
        spinner.classList.remove('hidden');
        status.textContent = isThreadCreated
          ? 'Переиспользуем существующий воркер...'
          : 'Создаем новый воркер...';
        result.textContent = 'Ожидаем результат...';

        // Создаем Web Worker только если он еще не был создан
        if (!isThreadCreated) {
          thread = new Worker('./thread.js');
          isThreadCreated = true;

          // Обработчик сообщений от воркера
          thread.onmessage = (event) => {
            const data = event.data;

            if (data.type === 'progress') {
              status.textContent = `Прогресс: ${data.progress}%`;
            } else if (data.type === 'result') {
              // Получаем результат
              result.innerHTML = `
                          <h3>Результат вычислений:</h3>
                          <p><strong>Значение:</strong> ${data.result}</p>
                          <p><strong>Время выполнения:</strong> ${data.duration}мс</p>
                          <p><strong>Итераций:</strong> ${data.iterations}</p>
                      `;

              // Скрываем анимацию и разблокируем кнопку
              spinner.classList.add('hidden');
              button.disabled = false;
              button.textContent = 'Запустить вычисления! (Воркер готов)';
              status.textContent = 'Готово! Анимация работала плавно.';
            }
          };

          // Обработчик ошибок воркера
          thread.onerror = (error) => {
            console.error('Ошибка в Web Worker:', error);
            result.textContent = 'Произошла ошибка при выполнении вычислений.';
            spinner.classList.add('hidden');
            button.disabled = false;
            button.textContent = 'Запустить вычисления! (Воркер готов)';
            status.textContent = 'Ошибка!';
          };
        }

        // Запускаем вычисления в воркере
        thread.postMessage({ timeout: 3000 });
      });

      // Демонстрация блокировки основного потока (для сравнения)
      document.getElementById('start').addEventListener('dblclick', () => {
        const button = document.getElementById('start');
        const spinner = document.getElementById('spinner');
        const status = document.getElementById('status');
        const result = document.getElementById('result');

        button.disabled = true;
        button.textContent = 'Блокируем основной поток...';
        spinner.classList.remove('hidden');
        status.textContent = 'ВНИМАНИЕ: Анимация будет тормозить!';
        result.textContent =
          'Выполняем тяжелые вычисления в основном потоке...';

        // Имитируем прогресс
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          status.textContent = `Прогресс в основном потоке: ${progress}%`;

          if (progress >= 100) {
            clearInterval(progressInterval);

            // Выполняем тяжелые вычисления в основном потоке
            const startTime = performance.now();
            const resultValue = slowFunction(2000);
            const endTime = performance.now();

            result.innerHTML = `
                        <h3>Результат (основной поток):</h3>
                        <p><strong>Значение:</strong> ${resultValue}</p>
                        <p><strong>Время выполнения:</strong> ${Math.round(
                          endTime - startTime
                        )}мс</p>
                        <p><strong>Примечание:</strong> Анимация могла тормозить!</p>
                    `;

            spinner.classList.add('hidden');
            button.disabled = false;
            button.textContent = 'Запустить вычисления!';
            status.textContent = 'Готово! (Анимация могла тормозить)';
          }
        }, 200);
      });
    </script>
  </body>
</html>
